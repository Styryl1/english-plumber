---
import fs from 'node:fs';
import path from 'node:path';

const sourcePath = path.join(process.cwd(), 'src/mirror/live-index.html');

if (!fs.existsSync(sourcePath)) {
  throw new Error('Missing src/mirror/live-index.html. Run: npm run clone:live');
}

const sourceHtml = fs.readFileSync(sourcePath, 'utf-8');

function decodeEntities(input: string): string {
  return input
    .replaceAll('&amp;', '&')
    .replaceAll('&quot;', '"')
    .replaceAll('&#x27;', "'")
    .replaceAll('&#39;', "'")
    .replaceAll('&lt;', '<')
    .replaceAll('&gt;', '>');
}

function extractOpenTag(tagName: string): string {
  const match = sourceHtml.match(new RegExp(`<${tagName}\\b[^>]*>`, 'i'));
  return match ? match[0] : '';
}

function extractInner(tagName: string): string {
  const match = sourceHtml.match(new RegExp(`<${tagName}\\b[^>]*>([\\s\\S]*?)<\\/${tagName}>`, 'i'));
  return match ? match[1] : '';
}

function parseAttrs(openTag: string, tagName: string): Record<string, string> {
  const attrs: Record<string, string> = {};
  if (!openTag) return attrs;

  const tagOnlyPattern = new RegExp(`^<${tagName}\\b|>$`, 'gi');
  const attrSource = openTag.replace(tagOnlyPattern, '');
  const attrPattern = /([:@A-Za-z0-9_-]+)(?:="([^"]*)")?/g;

  for (const match of attrSource.matchAll(attrPattern)) {
    const key = match[1];
    if (!key) continue;
    const value = match[2] ? decodeEntities(match[2]) : '';
    attrs[key] = value;
  }

  return attrs;
}

const htmlAttrs = parseAttrs(extractOpenTag('html'), 'html');
const bodyAttrs = parseAttrs(extractOpenTag('body'), 'body');

const htmlLang = htmlAttrs.lang || 'en';
const htmlClass = htmlAttrs.class || '';
const bodyClass = bodyAttrs.class || '';

delete htmlAttrs.lang;
delete htmlAttrs.class;
delete bodyAttrs.class;

const headInner = extractInner('head');
const bodyInner = extractInner('body');
---

<!doctype html>
<html lang={htmlLang} class={htmlClass} {...htmlAttrs}>
  <head>
    <script is:inline>
      (() => {
        const originalAppendChild = Element.prototype.appendChild;
        const originalInsertBefore = Element.prototype.insertBefore;

        const shouldBlockRemoteScript = (node) => {
          if (!(node instanceof HTMLScriptElement)) return false;

          const rawSrc = (node.getAttribute('src') || node.src || '').trim();
          if (!rawSrc) return false;
          if (rawSrc.startsWith('/')) return false;

          try {
            const parsed = new URL(rawSrc, window.location.href);
            const isRemote = parsed.origin !== window.location.origin;
            if (!isRemote) return false;
            return true;
          } catch {
            return false;
          }
        };

        const guardInsertion = (node) => {
          if (shouldBlockRemoteScript(node)) {
            return false;
          }
          return true;
        };

        Element.prototype.appendChild = function appendChildGuard(node) {
          if (!guardInsertion(node)) return node;
          return originalAppendChild.call(this, node);
        };

        Element.prototype.insertBefore = function insertBeforeGuard(node, child) {
          if (!guardInsertion(node)) return node;
          return originalInsertBefore.call(this, node, child);
        };
      })();
    </script>
    <Fragment set:html={headInner} />
    <style is:inline>
      button.fixed.bottom-5.left-5.z-40.hover\:scale-110.transition-transform {
        display: none !important;
      }

      [role='dialog']:has(img[alt*='percent off' i]),
      [role='dialog']:has(img[src*='25percentoff']),
      [role='dialog']:has(input#name):has(input#email):has(button[type='submit']) {
        display: none !important;
      }

      [data-hide-promo='flash-sale'] {
        display: none !important;
      }

      [data-hide-promo='overlay'] {
        display: none !important;
      }

      .hero-video-wrapper {
        background-image: url('/IMG_8233.PNG') !important;
        background-size: cover !important;
        background-position: center center !important;
        background-repeat: no-repeat !important;
      }

      .hero-video-wrapper video,
      .hero-video-wrapper iframe,
      .hero-video-wrapper canvas {
        display: none !important;
        pointer-events: none !important;
      }

      .safe-h-screen[data-theme='dark'] {
        background-image: url('/IMG_8233.PNG') !important;
        background-size: cover !important;
        background-position: center center !important;
        background-repeat: no-repeat !important;
      }

      [data-hide-hero-overlay='true'] {
        display: none !important;
      }

      html,
      body {
        pointer-events: auto !important;
      }

      html[data-scroll-locked],
      body[data-scroll-locked] {
        overflow: auto !important;
      }
    </style>
    <script is:inline>
      (() => {
        const promoMarker = 'data-hide-promo';
        const MEDIA_ORIGIN = 'https://www.gogeviti.com';
        const promoNeedles = [
          'get your discount',
          'your first step toward better health',
          'because proactive health should be accessible',
          'flash sale',
          '10% off',
          '25% off',
        ];

        const normalize = (value) => (value || '').replace(/\s+/g, ' ').trim().toLowerCase();
        const mediaPathPrefixes = [
          '/_next/image?',
          '/banner/',
          '/reviews/',
          '/footer/',
          '/faq.webp',
        ];
        const BUSINESS_NAME = 'English Plumber';
        const BASE_CITY = 'Medemblik';
        const WHATSAPP_NUMBER = '+31 6 428 699 31';
        const PRIMARY_AREA = 'Hoorn, Heerhugowaard, Purmerend, Alkmaar';
        const HERO_IMAGE_PATH = '/IMG_8233.PNG';

        const exactTextReplacements = new Map([
          ['Geviti | Blood Testing & Personalized Longevity Care', `${BUSINESS_NAME} | Plumbing & Heating in ${BASE_CITY}`],
          ['Get 25% Off - 24 Hour Flash Sale', `Friendly local plumber in ${BASE_CITY}`],
          ['Bloodwork', 'Boiler Servicing'],
          ['Supplements', 'Radiator Services'],
          ['Diagnostics', 'Tap Repairs'],
          ['Rx Therapies', 'Plumbing Handyman'],
          ['Blog', 'Service Area'],
          ['Gift Geviti', 'WhatsApp'],
          ['Login', 'Dutch + English'],
          ['Try Geviti', 'Free Quote'],
          ['Your Best Years', 'Friendly Local Plumber'],
          ["Haven't Happened Yet.", `Based in ${BASE_CITY}.`],
          [
            'Comprehensive blood testing and personalized care designed to keep you thriving, today and for decades to come.',
            `${BUSINESS_NAME} helps expats and Dutch homeowners with reliable plumbing and heating in ${BASE_CITY} and nearby towns.`,
          ],
          ['Start Testing', 'Free Quote'],
          ['One Blood Test', 'One Trusted Plumber'],
          ['Total Optimization', 'Fast, Clean Repairs'],
          ['Test My Biomarkers Now', `WhatsApp ${WHATSAPP_NUMBER}`],
          ['Metabolic Health', 'Boiler Servicing'],
          ['Kidney and Liver Function', 'Radiator Installation'],
          ['Cardiovascular Health', 'Radiator Repair'],
          ['Hormone Levels', 'Tap Repair'],
          ['Nutrient Levels', 'Tap Replacement'],
          ['Inflammation Markers', 'General Plumbing'],
          ['Immunity Markers', 'Heating Checks'],
          ['Biological Aging Rate', 'Home Plumbing Checks'],
          ['Autoimmune Indicators', 'Leak Detection'],
          ['Blood Cell Analysis', 'Boiler Brands: Vaillant, Intergas, Remeha, ATAG'],
          ['At-home', 'Home'],
          ['Lab Tests', 'Plumbing Visits'],
          ['Learn More', 'View Service'],
          ['Customized', 'Transparent'],
          ['Not Just Bloodwork,', 'Not Just Quick Fixes,'],
          ['Total Body Optimization', 'Complete Home Plumbing Support'],
          [
            'Other testing companies stop at the bloodwork. We go beyond by offering access to personalized supplement packs and tailored health protocols, custom built according to the needs of your body. No more guesswork.',
            'Most companies patch the issue. We diagnose the cause and fix it properly with clear communication, fair pricing, and practical solutions.',
          ],
          ['100+', '95 EUR'],
          ['Biomarkers', 'per hour'],
          ['Tested', 'labour'],
          ['12+', '145 EUR'],
          ['Health Categories', 'boiler servicing'],
          ['Prescription Medications', 'Free quotes'],
          ['Personal Care Team', 'CO-vakmanschap + VCA'],
          ['Bye bye sick care,', 'No confusing jargon,'],
          ['hello true health care', 'just honest plumbing help.'],
          [
            'Our team of functional medicine experts approach care from a proactive and preventative lens. By marrying this approach with our cutting edge technology, and the most advanced longevity therapeutics, we help you achieve a longer, healthier life.',
            `${BUSINESS_NAME} is a friendly local service in ${BASE_CITY}. We support expats and Dutch homeowners with clear advice, quality repairs, and reliable follow-up.`,
          ],
          ['HSA/FSA', 'English + Dutch'],
          ['ACCEPTED', 'spoken'],
          ['Thousands trust geviti', 'Trusted by local homes'],
          ['with their health', 'for plumbing and heating'],
          ['@realalexclark', `${BASE_CITY} service`],
          ['Host of Culture Apothecary, 553K followers', 'WhatsApp-first support'],
          ['Cathy F.', 'Customer Review'],
          ['Verified Geviti Member', 'Verified Local Client'],
          [
            'I love that I get to meet with the clinician online and get personalized care rather than having to go into an office.',
            'Quick response, clear communication in English, and the repair was done cleanly.',
          ],
          ['@nobleroadranch', 'Hoorn'],
          ['1.4M followers', 'Service area'],
          ['Brenda M.', 'Customer Review'],
          [
            'They really dug into my results and looked for my root cause of issues Iâ€™ve been experiencing for years. I finally feel like Iâ€™m not crazy for how I feel everyday and why I had no energy or anything just to do the simplest tasks day to day. Itâ€™s nice to feel my body responding well to the supplements and the care I am receiving from my care team.',
            'Friendly service and transparent pricing. My radiator issue was fixed quickly and everything was explained clearly.',
          ],
          ['Mark L.', 'Customer Review'],
          [
            'As someone who used to struggle with constant fatigue, low energy, and poor sleep, I can honestly say that Geviti has been a life-changing experience...Within a few weeks, I noticed a significant boost in my energy levels, and my sleep habits improved dramatically. The personalized wellness plan gave me the tools I needed to not only feel better in the short term but also improve my overall health as I age. Gevitiâ€™s approach to health is unlike anything Iâ€™ve experienced before.',
            'Boiler servicing was smooth and professional. Heating is stable again and communication over WhatsApp made everything easy.',
          ],
          ['@flyingwithbigern', 'Purmerend'],
          ['130K followers', 'Service area'],
          ['Angela D.', 'Customer Review'],
          [
            'In the two months since beginning the supplementation protocol given to me by my provider, I have only noticed positive changes... Instead of feeling as though I could fall asleep at any point throughout the day, I have noticed that my energy levels feel more like they used to be... I thought I was a healthy 50-year-old and that I would use Geviti to stay ahead of any future problems, but I am so happy to find that I am feeling better than I thought was possible.',
            'Great option for expats in North Holland. Easy to share photos on WhatsApp and book the right visit quickly.',
          ],
          ['@baiwood', 'Alkmaar'],
          ['15.8k followers', 'Service area'],
          ['Your Health Command Center,', 'Your Plumbing Command Center,'],
          [
            'The Geviti app brings together your bloodwork, dedicated care team, supplements, appointments, and daily health tracking into a single, seamless experienceâ€”making it effortless to stay on top of your longevity journey.',
            `Send photos and short videos on WhatsApp. ${BUSINESS_NAME} reviews the issue, shares a clear quote, and books your visit quickly.`,
          ],
          ['Start With Geviti Today', `Start With ${BUSINESS_NAME}`],
          ['How Does', 'How'],
          ['it work', 'it works'],
          ['At-Home Labs', 'Send Photos on WhatsApp'],
          ['A licensed phlebotomist comes to your home, on your schedule. No waiting rooms, no hassle.', 'Share photos or a short video of the issue and your postcode.'],
          ['Makor AI Analyzes', 'Problem Review'],
          ['Makor AI analyzes your biomarkers against optimal health ranges and validated clinical protocols.', 'We review the issue and recommend the best repair approach.'],
          ['Personalized Care Plan', 'Clear Quote & Plan'],
          ['Our expert team builds your Longeviti Blueprint with personalized nutrition, supplements, and lifestyle guidance.', 'You get transparent pricing: 95 EUR per hour labour and 145 EUR for boiler servicing.'],
          ['Ongoing Optimization', 'Repair & Follow-Up'],
          ['Retest every 6 months. Your care team refines your plan as your body evolves.', 'We complete the job cleanly and stay available for follow-up questions.'],
          ['Choose Your Path', 'Choose Your Service'],
          [
            'Explore The Right Plan Tailored To Match Your Specific Requirements And Ambitions',
            `Plumbing and heating support tailored for homes in and around ${BASE_CITY}.`,
          ],
          ['Lite', 'Standard'],
          ['Advanced Bloodwork twice annually', 'General plumbing visit'],
          ['$66.67/mo', '95 EUR / hour'],
          ['(billed at $399.99 every 6mo)', 'Boiler servicing: 145 EUR'],
          ['Semi-Annually', 'Hourly labour'],
          ['Annually', 'Fixed boiler service'],
          ['-15%', 'Free quote'],
          ['Comprehensive Labs and Review', 'Boiler, tap and radiator repairs'],
          ['100+ biomarker bloodwork every 6mo', 'No drain services'],
          ['At-home blood draw*', `Home visits in ${BASE_CITY} area`],
          ['Personalized longevity action plan', 'Clear diagnosis and repair plan'],
          ['Access to custom supplement packs', 'Quality parts when required'],
          ['In-app support', 'WhatsApp photo support + basic workmanship warranty'],
          ['Currently unavailable in', 'Not based in'],
          ['AK, HI, RI', 'Amsterdam or Almere'],
          ['Get Started', 'WhatsApp Now'],
          ['Most Popular', 'Most Requested'],
          ['Plus', 'Heating Focus'],
          ['Ideal for those serious about longevity', 'Ideal for boiler and radiator issues'],
          ['$129.99/mo', '95 EUR / hour'],
          ['(billed at $779.99 every 6mo)', 'Boiler servicing: 145 EUR'],
          ['Everything in Lite, and', 'Everything in Standard, and'],
          ['45 min expert bloodwork review', 'Detailed heating system diagnosis'],
          ['Dedicated Functional Longevity Specialist', 'Boiler brands: Vaillant, Intergas, Remeha, ATAG'],
          ['Quarterly Virtual Visits', 'Flexible appointment windows'],
          ['Exclusive Savings', 'Transparent pricing'],
          ['40% off custom supplement protocol', 'Free no-obligation quote'],
          ['Preferred pricing on specialty diagnostics', 'Fair parts pricing'],
          ['Plus Rx', 'Local Priority'],
          ['Complete clinical care solution', 'Complete plumbing and heating support'],
          ['$149.83/mo', 'WhatsApp for quote'],
          ['(billed at $898.98 every 6mo)', 'Send photos and text for fast triage'],
          ['Everything in Plus, and', 'Everything in Heating Focus, and'],
          ['Quarterly Longevity Practitioner visits', 'Planned maintenance options'],
          ['Peptide therapy protocols', 'Radiator installation and repair'],
          ['Hormone optimization therapies', 'Tap repair and replacement'],
          ['Access to other longevity solutions', 'General plumbing handyman'],
          ['Plus Rx is exclusively available in:', `Primary service area from ${BASE_CITY}:`],
          ['AZ, CA, CO, DE, FL, GA, IL, IN, KS, LA, MA, MD, MI, MN, MO, MS, NC, NH, NM, NV, OH, OR, PA, TN, TX, UT, VA, WA, WI', `${PRIMARY_AREA} (and nearby towns within ~40km)`],
          ['Frequently Asked Questions', 'Frequently Asked Plumbing Questions'],
          ['What states does Geviti Lite and Geviti Plus cover?', `Where does ${BUSINESS_NAME} provide service?`],
          ['Geviti Lite and Geviti plus are available in all states with the exception of AK, HI, and RI.', `Primary service area includes ${BASE_CITY}, ${PRIMARY_AREA}. Nearby towns within about 40km are also possible.`],
          ['What states does Geviti Plus Rx cover?', 'Do you work in Amsterdam or Almere?'],
          ['Geviti Plus Rx is available in AZ, CA, CO, DE, FL, GA, IL, IN, KS, LA, MA, MD, MI, MN, MO, MS, NC, NH, NM, NV, OH, OR, PA, TN, TX, UT, VA, WA, WI. We are actively working to expand to all 50 states in the future.', 'Not based in Amsterdam or Almere. If your location is nearby, send a WhatsApp message and we can confirm availability.'],
          ['Why should I choose Gevitiâ€™s Longeviti Blend instead of buying my own supplements?', 'What services do you offer?'],
          ['The Longeviti Blend is personalized to your bloodwork, ensuring you get exactly what your body needs. While you are not required to purchase supplements from us, many members choose to because of the quality and convenience. We use Xymogen, one of the most trusted and well-researched brands in the industry, so you can feel confident in what youâ€™re taking. Your blend also comes in ready-to-go morning and evening packets, making it simple to stay consistent and stick with your plan long term.', 'Boiler servicing, radiator installation and repair, tap repair and replacement, and general plumbing handyman work. We do not offer drain services.'],
          ["How does Geviti's 'Longeviti Panel' compare to the bloodwork from my Primary Care Physician?", 'How does pricing work?'],
          ['Most primary care physicians test for only a small set of markers that insurance will cover, often focused on detecting disease once it is already present. The Longeviti Panel takes a broader, more proactive approach by measuring over five times as many biomarkers. Beyond the basics, we look at key areas such as kidney and liver function, cardiovascular health, hormones, nutrients, inflammation, and immunity. This broader view helps us uncover insights into your metabolic health and longevity pathways, so you can take action to optimize your health before problems develop.', '95 EUR per hour labour, 145 EUR for boiler servicing, and free quotes. WhatsApp photos and text for a fast first assessment.'],
          ['Still have questions?', 'Still have questions?'],
          ['Feel free to leave a message for us', 'Send a WhatsApp message and include photos of the problem.'],
          ['Message us', 'WhatsApp us'],
          ['Nathan Graville', BUSINESS_NAME],
          ['Founder and CEO @ Geviti', `Friendly local plumber in ${BASE_CITY}`],
          ['We Are On A', 'Built Around'],
          ['Personal Mission', 'Clear, Reliable Service'],
          ['After our Founder, Nate Graville, lost his father to what he believes to be a largely preventable disease, he felt compelled to build the system his father never had. Geviti exists to keep you healthy and vibrant through all stages of life, to allow for more memories with your loved ones.', `${BUSINESS_NAME} was built to give expats and Dutch homeowners a reliable plumber with clear communication, fair pricing, and quality workmanship.`],
          ['Start Your Journey', 'Book Your Visit'],
          ['Seamlessly Connected', 'Quickly Connected'],
          ['to Your Life', 'to Your Home'],
          ['Ready to experience', 'Ready for fast plumbing help?'],
          ['the future of health?', 'Send photos on WhatsApp and get a clear plan.'],
          ["Your body is sending signals. Weâ€™ll help you decode them before it's too late.", 'From boiler issues to leaking taps, we help you solve problems before they become expensive.'],
          ['Join Today', 'Message on WhatsApp'],
          ['Stay in the loop with exclusive offers and product previews.', 'Best contact method: WhatsApp with photos and a short description.'],
          ['Subscribe', 'Send Photos'],
          ['Become An Ambassador', 'For Landlords'],
          ['Become A Brand Partner', 'For Trade Partners'],
          ['About Geviti', `About ${BUSINESS_NAME}`],
          ['Careers', 'Service Updates'],
          ['Blogs', 'Plumbing Tips'],
          [
            'LAB TESTS ARE ORDERED SOLELY AT THE DISCRETION OF LICENSED CLINICIANS. IF A PHYSICIAN DECIDES NOT TO ORDER A TEST, THE COST WILL BE REFUNDED. PRODUCT IMAGES ARE FOR DISPLAY PURPOSES ONLY; ACTUAL ITEMS DISPENSED FROM U.S.-BASED PHARMACIES MAY VARY. THE COST PER MONTH FOR PRESCRIPTION (RX) PRODUCTS IS BASED ON AN AVERAGE DOSING. YOUR COST MAY BE HIGHER OR LOWER DEPENDING ON YOUR PERSONALIZED CARE PLAN. ALL PROFESSIONAL MEDICAL SERVICES ARE PROVIDED BY LICENSED PHYSICIANS AND CLINICIANS PRACTICING THROUGH INDEPENDENTLY OWNED AND PROFESSIONALLY MANAGED MEDICAL GROUPS. GEVITI IS A HEALTHCARE TECHNOLOGY COMPANY AND NOT A LABORATORY OR MEDICAL PROVIDER. ALL LABORATORY AND MEDICAL SERVICES ARE DELIVERED BY INDEPENDENT THIRD-PARTY ENTITIES.',
            `${BUSINESS_NAME} provides plumbing and heating services in North Holland. Final scope and parts pricing are confirmed after assessment. Emergency 24/7 callouts are not offered.`,
          ],
          ['Find us on the App Store and Google Play Store', 'WhatsApp is the fastest way to reach us.'],
          ['Geviti Inc. | All Rights Reserved', `${BUSINESS_NAME} | All Rights Reserved`],
        ]);

        const regexTextReplacements = [
          [/\bGeviti\b/g, BUSINESS_NAME],
          [/\bLongeviti\b/g, 'Plumbing'],
          [/\bbiomarkers?\b/gi, 'plumbing and heating'],
          [/\bwellness\b/gi, 'home comfort'],
          [/\blongevity\b/gi, 'long-term home reliability'],
        ];
        const copyAttributeNames = ['title', 'alt', 'aria-label', 'placeholder', 'content'];

        const normalizeTextValue = (value) => (value || '').replace(/\s+/g, ' ').trim();
        const rewriteCopyString = (value) => {
          if (!value) return value;
          const normalized = normalizeTextValue(value);
          if (normalized && exactTextReplacements.has(normalized)) {
            const replacement = exactTextReplacements.get(normalized) || normalized;
            const leading = value.match(/^\s*/)?.[0] || '';
            const trailing = value.match(/\s*$/)?.[0] || '';
            return `${leading}${replacement}${trailing}`;
          }

          let nextValue = value;
          for (const [pattern, replacement] of regexTextReplacements) {
            nextValue = nextValue.replace(pattern, replacement);
          }
          return nextValue;
        };

        const rewriteTextNodeCopy = (node) => {
          if (!(node instanceof Text)) return;
          const parent = node.parentElement;
          if (!parent) return;
          if (parent.closest('script,style,noscript')) return;
          const value = node.nodeValue;
          if (!value || !value.trim()) return;
          const nextValue = rewriteCopyString(value);
          if (nextValue !== value) {
            node.nodeValue = nextValue;
          }
        };

        const rewriteElementCopyAttrs = (element) => {
          if (!(element instanceof Element)) return;
          for (const attrName of copyAttributeNames) {
            const value = element.getAttribute(attrName);
            if (!value) continue;
            const nextValue = rewriteCopyString(value);
            if (nextValue !== value) {
              element.setAttribute(attrName, nextValue);
            }
          }
        };

        const rewriteDocumentMetadata = () => {
          document.title = `${BUSINESS_NAME} | Plumbing & Heating in ${BASE_CITY}`;
          const description = `${BUSINESS_NAME} is a friendly local plumber in ${BASE_CITY}. Boiler servicing, radiator repairs, tap repairs, and general plumbing handyman work. WhatsApp ${WHATSAPP_NUMBER}.`;
          document
            .querySelectorAll(
              'meta[name="description"],meta[property="og:description"],meta[name="twitter:description"]',
            )
            .forEach((meta) => meta.setAttribute('content', description));
          document
            .querySelectorAll('meta[property="og:title"],meta[name="twitter:title"]')
            .forEach((meta) => meta.setAttribute('content', document.title));
        };

        const rewriteCopyInRoot = (root) => {
          if (!(root instanceof Element || root instanceof Document)) return;

          if (root instanceof Element) {
            rewriteElementCopyAttrs(root);
          }

          const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT);
          let textNode = walker.nextNode();
          while (textNode) {
            rewriteTextNodeCopy(textNode);
            textNode = walker.nextNode();
          }

          root.querySelectorAll('*').forEach((element) => rewriteElementCopyAttrs(element));
          if (root instanceof Document || root === document.documentElement || root === document.body) {
            rewriteDocumentMetadata();
          }
        };

        const isApiMediaPath = (value) => {
          if (!value) return false;
          return (
            value.startsWith('/api/media/file/') ||
            value.startsWith(`${MEDIA_ORIGIN}/api/media/file/`)
          );
        };

        const clampWidth = (value) => {
          if (!Number.isFinite(value) || value <= 0) return 1920;
          return Math.max(96, Math.min(3840, Math.round(value)));
        };

        const getWidthHintFromNode = (node) => {
          if (!(node instanceof Element)) return 1920;
          const widthAttr = Number.parseInt(node.getAttribute('width') || '', 10);
          if (Number.isFinite(widthAttr) && widthAttr > 0) {
            return clampWidth(widthAttr * 2);
          }
          return 1920;
        };

        const toMediaOptimizerUrl = (value, widthHint = 1920) => {
          if (!value) return value;
          let path = value.trim();
          if (!path) return path;

          if (path.startsWith(`${MEDIA_ORIGIN}/api/media/file/`)) {
            path = path.slice(MEDIA_ORIGIN.length);
          }

          if (!path.startsWith('/api/media/file/')) {
            return value;
          }

          const w = clampWidth(widthHint);
          return `${MEDIA_ORIGIN}/_next/image?url=${encodeURIComponent(path)}&w=${w}&q=75`;
        };

        const absolutizeMediaUrl = (value) => {
          if (!value) return value;
          const trimmed = value.trim();
          if (!trimmed) return trimmed;

          if (isApiMediaPath(trimmed)) {
            return toMediaOptimizerUrl(trimmed, 1920);
          }

          const alreadyAbsolute =
            trimmed.startsWith('http://') ||
            trimmed.startsWith('https://') ||
            trimmed.startsWith('data:') ||
            trimmed.startsWith('blob:');
          if (alreadyAbsolute) {
            return trimmed;
          }

          if (mediaPathPrefixes.some((prefix) => trimmed.startsWith(prefix))) {
            return `${MEDIA_ORIGIN}${trimmed}`;
          }

          return trimmed;
        };

        const absolutizeSrcSet = (srcSetValue, node) => {
          if (!srcSetValue) return srcSetValue;
          const defaultWidth = getWidthHintFromNode(node);

          return srcSetValue
            .split(',')
            .map((chunk) => {
              const token = chunk.trim();
              if (!token) return token;
              const splitIndex = token.search(/\s/);
              if (splitIndex === -1) {
                if (isApiMediaPath(token)) {
                  return toMediaOptimizerUrl(token, defaultWidth);
                }
                return absolutizeMediaUrl(token);
              }

              const urlPart = token.slice(0, splitIndex);
              const descriptor = token.slice(splitIndex);
              if (isApiMediaPath(urlPart)) {
                const widthMatch = descriptor.match(/(\d+)w/);
                const widthFromDescriptor = widthMatch ? Number.parseInt(widthMatch[1], 10) : defaultWidth;
                return `${toMediaOptimizerUrl(urlPart, widthFromDescriptor)}${descriptor}`;
              }

              return `${absolutizeMediaUrl(urlPart)}${descriptor}`;
            })
            .join(', ');
        };

        const rewriteInlineStyleUrls = (styleValue) => {
          if (!styleValue) return styleValue;
          return styleValue.replace(
            /url\((['"]?)(\/(?:_next\/image\?|api\/media\/file\/|banner\/|reviews\/|footer\/|faq\.webp)[^'")]+)\1\)/gi,
            (_match, quote, path) => {
              if (path.startsWith('/api/media/file/')) {
                return `url(${quote}${toMediaOptimizerUrl(path, 1920)}${quote})`;
              }
              return `url(${quote}${MEDIA_ORIGIN}${path}${quote})`;
            },
          );
        };

        const rewriteNodeMediaUrls = (node) => {
          if (!(node instanceof Element)) return;

          const src = node.getAttribute('src');
          if (src) {
            const nextSrc = isApiMediaPath(src)
              ? toMediaOptimizerUrl(src, getWidthHintFromNode(node))
              : absolutizeMediaUrl(src);
            if (nextSrc !== src) node.setAttribute('src', nextSrc);
          }

          const href = node.getAttribute('href');
          if (href && node.tagName === 'LINK') {
            const nextHref = absolutizeMediaUrl(href);
            if (nextHref !== href) node.setAttribute('href', nextHref);
          }

          const srcSet = node.getAttribute('srcset');
          if (srcSet) {
            const nextSrcSet = absolutizeSrcSet(srcSet, node);
            if (nextSrcSet !== srcSet) node.setAttribute('srcset', nextSrcSet);
          }

          const imageSrcSet = node.getAttribute('imagesrcset');
          if (imageSrcSet) {
            const nextImageSrcSet = absolutizeSrcSet(imageSrcSet, node);
            if (nextImageSrcSet !== imageSrcSet) node.setAttribute('imagesrcset', nextImageSrcSet);
          }

          const style = node.getAttribute('style');
          if (style && style.includes('url(')) {
            const nextStyle = rewriteInlineStyleUrls(style);
            if (nextStyle !== style) node.setAttribute('style', nextStyle);
          }
        };

        const rewriteMediaUrlsInRoot = (root) => {
          if (!(root instanceof Element || root instanceof Document)) return;

          if (root instanceof Element) {
            rewriteNodeMediaUrls(root);
          }

          root.querySelectorAll('img,source,link,[style*="url("]').forEach((node) => {
            rewriteNodeMediaUrls(node);
          });
        };

        const enforceHeroImage = (root) => {
          if (!(root instanceof Element || root instanceof Document)) return;
          const heroSections = [];

          if (root instanceof Element && root.classList.contains('safe-h-screen')) {
            heroSections.push(root);
          }

          root
            .querySelectorAll('.safe-h-screen[data-theme="dark"], .safe-h-screen')
            .forEach((section) => heroSections.push(section));

          heroSections.forEach((section) => {
            if (!(section instanceof HTMLElement)) return;
            section.style.backgroundImage = `url('${HERO_IMAGE_PATH}')`;
            section.style.backgroundSize = 'cover';
            section.style.backgroundPosition = 'center center';
            section.style.backgroundRepeat = 'no-repeat';

            Array.from(section.children).forEach((child) => {
              if (!(child instanceof HTMLElement)) return;
              if (child.classList.contains('hero-video-wrapper')) return;

              const className = child.getAttribute('class') || '';
              const styleValue = child.getAttribute('style') || '';
              const isDarkOverlay =
                className.includes('-z-[9]') || styleValue.includes('#14191A') || styleValue.includes('#14191a');

              if (isDarkOverlay) {
                child.setAttribute('data-hide-hero-overlay', 'true');
              }
            });
          });

          const wrappers = [];

          if (root instanceof Element && root.classList.contains('hero-video-wrapper')) {
            wrappers.push(root);
          }

          root.querySelectorAll('.hero-video-wrapper').forEach((wrapper) => wrappers.push(wrapper));

          wrappers.forEach((wrapper) => {
            if (!(wrapper instanceof HTMLElement)) return;

            wrapper.style.backgroundImage = `url('${HERO_IMAGE_PATH}')`;
            wrapper.style.backgroundSize = 'cover';
            wrapper.style.backgroundPosition = 'center center';
            wrapper.style.backgroundRepeat = 'no-repeat';
            wrapper.style.zIndex = '0';
            wrapper.style.overflow = 'hidden';

            wrapper.querySelectorAll('video,iframe,canvas').forEach((media) => {
              if (media instanceof HTMLVideoElement) {
                try {
                  media.pause();
                } catch {}
              }
              media.setAttribute('aria-hidden', 'true');
              media.style.display = 'none';
              media.style.pointerEvents = 'none';
            });

            Array.from(wrapper.children).forEach((child) => {
              if (
                child instanceof HTMLImageElement &&
                child.getAttribute('data-hero-image') === 'english-plumber'
              ) {
                return;
              }
              child.remove();
            });

            let image = wrapper.querySelector('img[data-hero-image="english-plumber"]');
            if (!(image instanceof HTMLImageElement)) {
              image = document.createElement('img');
              image.setAttribute('data-hero-image', 'english-plumber');
              image.setAttribute('alt', 'English Plumber hero image');
              image.setAttribute('loading', 'eager');
              image.setAttribute('decoding', 'async');
              image.setAttribute('fetchpriority', 'high');
              image.setAttribute('aria-hidden', 'true');
              image.className = 'absolute inset-0 w-full h-full object-cover object-center';
              image.style.pointerEvents = 'none';
              image.style.zIndex = '0';
              wrapper.append(image);
            }

            if (image.getAttribute('src') !== HERO_IMAGE_PATH) {
              image.setAttribute('src', HERO_IMAGE_PATH);
            }
          });
        };

        const markHidden = (element, marker = 'flash-sale') => {
          if (element && element instanceof HTMLElement) {
            element.setAttribute(promoMarker, marker);
            element.setAttribute('aria-hidden', 'true');
            element.style.setProperty('display', 'none', 'important');
            element.style.setProperty('visibility', 'hidden', 'important');
            element.style.setProperty('pointer-events', 'none', 'important');
            element.style.setProperty('opacity', '0', 'important');
          }
        };

        const isGiftTriggerButton = (element) => {
          if (!(element instanceof Element) || element.tagName !== 'BUTTON') return false;
          const text = normalize(element.textContent);
          if (text.includes('ðŸŽ')) return true;
          if (element.matches('button.fixed.bottom-5.left-5.z-40.hover\\:scale-110.transition-transform')) {
            return true;
          }
          return false;
        };

        const isDiscountDialog = (element) => {
          if (!(element instanceof Element)) return false;
          if (element.getAttribute('role') !== 'dialog') return false;

          const text = normalize(element.textContent);
          if (promoNeedles.some((needle) => text.includes(needle))) return true;

          if (element.querySelector('img[alt*="percent off" i], img[src*="25percentoff"], img[src*="/banner/"]')) {
            return true;
          }

          if (
            element.querySelector('button[type="submit"]') &&
            element.querySelector('input#name') &&
            element.querySelector('input#email')
          ) {
            return true;
          }

          return false;
        };

        const hideNearbyOverlays = (dialog) => {
          if (!(dialog instanceof Element)) return;
          const container = dialog.parentElement || document.body;
          container.querySelectorAll('[data-state="open"]').forEach((candidate) => {
            if (!(candidate instanceof Element)) return;
            if (candidate === dialog) return;
            if (candidate.getAttribute('role') === 'dialog') return;

            const className = (candidate.getAttribute('class') || '').toLowerCase();
            const looksLikeOverlay =
              className.includes('inset-0') ||
              className.includes('backdrop') ||
              className.includes('overlay') ||
              className.includes('bg-black');

            if (looksLikeOverlay) {
              markHidden(candidate, 'overlay');
            }
          });
        };

        const hidePromoInRoot = (root) => {
          if (!(root instanceof Element || root instanceof Document)) return;

          root.querySelectorAll('button').forEach((button) => {
            if (isGiftTriggerButton(button)) {
              markHidden(button);
            }
          });

          root.querySelectorAll('[role="dialog"]').forEach((dialog) => {
            if (isDiscountDialog(dialog)) {
              markHidden(dialog);
              hideNearbyOverlays(dialog);
            }
          });

          if (root instanceof Element) {
            if (isGiftTriggerButton(root)) {
              markHidden(root);
            }
            if (isDiscountDialog(root)) {
              markHidden(root);
              hideNearbyOverlays(root);
            }
          }
        };

        const hasVisibleDialog = () => {
          const candidates = document.querySelectorAll('[role="dialog"], [aria-modal="true"], [data-state="open"]');
          for (const node of candidates) {
            if (!(node instanceof HTMLElement)) continue;
            if (node.getAttribute(promoMarker)) continue;
            const style = window.getComputedStyle(node);
            if (style.display === 'none' || style.visibility === 'hidden' || style.opacity === '0') continue;
            if (node.getBoundingClientRect().width <= 0 || node.getBoundingClientRect().height <= 0) continue;
            return true;
          }
          return false;
        };

        const unlockInteractionLocks = () => {
          if (hasVisibleDialog()) return;

          const roots = [document.documentElement, document.body];
          roots.forEach((root) => {
            if (!(root instanceof HTMLElement)) return;

            if (root.style.pointerEvents === 'none') {
              root.style.setProperty('pointer-events', 'auto', 'important');
            }

            if (root.style.overflow === 'hidden') {
              root.style.removeProperty('overflow');
            }

            if (root.style.touchAction === 'none') {
              root.style.removeProperty('touch-action');
            }

            root.removeAttribute('inert');
            root.removeAttribute('data-scroll-locked');
          });

          document.querySelectorAll('#__next[inert], main[inert], [aria-hidden="true"][data-state="open"]').forEach((node) => {
            if (node instanceof HTMLElement) {
              node.removeAttribute('inert');
              if (node.getAttribute(promoMarker)) {
                node.removeAttribute('aria-hidden');
              }
            }
          });
        };

        const run = () => {
          rewriteMediaUrlsInRoot(document);
          enforceHeroImage(document);
          hidePromoInRoot(document);
          rewriteCopyInRoot(document);
          unlockInteractionLocks();
        };

        document.addEventListener(
          'click',
          (event) => {
            const target = event.target;
            if (!(target instanceof Element)) return;
            const button = target.closest('button');
            if (!button) return;
            if (isGiftTriggerButton(button)) {
              event.preventDefault();
              event.stopImmediatePropagation();
              markHidden(button);
            }
          },
          true,
        );

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', run, { once: true });
        } else {
          run();
        }

        window.setTimeout(() => {
          hidePromoInRoot(document);
          rewriteCopyInRoot(document);
          unlockInteractionLocks();
        }, 1200);

        const interactionWatchdog = window.setInterval(() => {
          hidePromoInRoot(document);
          unlockInteractionLocks();
        }, 400);

        const runWatchdogPass = () => {
          hidePromoInRoot(document);
          unlockInteractionLocks();
        };

        document.addEventListener('visibilitychange', runWatchdogPass);
        window.addEventListener('focus', runWatchdogPass);
        window.addEventListener('pointerdown', runWatchdogPass, true);
        window.addEventListener('beforeunload', () => {
          window.clearInterval(interactionWatchdog);
        });

        const observer = new MutationObserver((mutations) => {
          for (const mutation of mutations) {
            for (const addedNode of mutation.addedNodes) {
              if (addedNode instanceof Element) {
                rewriteMediaUrlsInRoot(addedNode);
                enforceHeroImage(addedNode);
                hidePromoInRoot(addedNode);
                unlockInteractionLocks();
              }
            }
          }
        });

        observer.observe(document.documentElement, {
          childList: true,
          subtree: true,
        });
      })();
    </script>
  </head>
  <body class={bodyClass} {...bodyAttrs}>
    <Fragment set:html={bodyInner} />
  </body>
</html>
