import fs from 'node:fs';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

const ROOT_DIR = path.resolve(path.dirname(fileURLToPath(import.meta.url)), '..');
const OUTPUT_FILE = path.join(ROOT_DIR, 'src/generated/mirror-runtime-bundle.js');

function readRequiredText(relativePath) {
  const fullPath = path.join(ROOT_DIR, relativePath);
  if (!fs.existsSync(fullPath)) {
    throw new Error(`Missing required file: ${relativePath}`);
  }
  return fs.readFileSync(fullPath, 'utf-8');
}

function readOptionalJson(relativePath, fallbackValue = {}) {
  const fullPath = path.join(ROOT_DIR, relativePath);
  if (!fs.existsSync(fullPath)) return fallbackValue;

  try {
    return JSON.parse(fs.readFileSync(fullPath, 'utf-8'));
  } catch {
    return fallbackValue;
  }
}

function toInlineJs(value) {
  return JSON.stringify(value).replace(/\u2028/g, '\\u2028').replace(/\u2029/g, '\\u2029');
}

const bundle = {
  sourceHtml: readRequiredText('src/mirror/live-index.html'),
  injections: {
    guard: readRequiredText('src/mirror/injections/guard.js').trim(),
    overridesCss: readRequiredText('src/mirror/injections/overrides.css').trim(),
    runtime: readRequiredText('src/mirror/injections/runtime.js').trim(),
  },
  siteContent: readOptionalJson('content/site/mirror-content.json', {}),
  tinaSiteOverrides: readOptionalJson('content/tina/site.json', {}),
  mediaManifest: readOptionalJson('src/generated/media-manifest.json', {}),
};

const fileContent = `// Auto-generated by scripts/generate_mirror_runtime_bundle.mjs\nexport const MIRROR_RUNTIME_BUNDLE = ${toInlineJs(bundle)};\n`;

fs.mkdirSync(path.dirname(OUTPUT_FILE), { recursive: true });
fs.writeFileSync(OUTPUT_FILE, fileContent);

console.log(`Generated ${path.relative(ROOT_DIR, OUTPUT_FILE)}`);
